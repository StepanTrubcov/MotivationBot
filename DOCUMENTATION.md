# Документация проекта MotivationBot (Winter Arc / Дневные достижения)

## Общее описание

**MotivationBot** — Telegram-бот для формирования дисциплины и полезных привычек. Проект включает два бота:

1. **Основной бот** — «Дневные достижения» / Winter Arc: цели, отметки за день, отчёты, напоминания.
2. **Бот поддержки** — FAQ-бот с ответами на частые вопросы по приложению и боту.

Мини-приложение (веб-приложение) размещено на Vercel: `https://motivation-oz64.vercel.app/`. Бот работает с внешним API этого приложения для хранения пользователей, целей и отчётов.

---

## Структура проекта

```
MotivationBot/
├── bot.js              # Точка входа: оба бота, команды, cron-задачи
├── Api/
│   └── Api.js          # Клиент к backend API (пользователи, цели, отчёты)
├── fonts/              # Шрифты для генерации SVG-графиков
│   └── fonts.conf
├── Img/                # Изображения (например, qr.jpg для поддержки)
├── package.json
├── .env                # Токены и переменные окружения (не в репозитории)
└── DOCUMENTATION.md    # Этот файл
```

---

## Зависимости

| Пакет      | Назначение                          |
|-----------|--------------------------------------|
| telegraf  | Работа с Telegram Bot API            |
| dotenv    | Загрузка переменных из `.env`        |
| axios     | HTTP-запросы к backend API           |
| node-cron | Расписание напоминаний и отчётов     |
| sharp     | Конвертация SVG в PNG (графики)      |
| express   | (подключён в проекте)                |

---

## Переменные окружения (.env)

| Переменная   | Описание |
|-------------|----------|
| `BOT_TOKEN` | Токен основного бота (Дневные достижения) |
| `BOT_TOKEN_`| Токен бота поддержки (FAQ) |

Для запуска основного бота обязателен `BOT_TOKEN`. Второй бот запускается только при наличии `BOT_TOKEN_`.

---

## Основной бот — команды и сценарии

### Команды

| Команда      | Описание |
|-------------|----------|
| `/start`    | Приветствие, описание бота, кнопка открытия мини-приложения |
| `/goals`    | Список целей: «в процессе» и «выполненные» |
| `/winter_arc` | Кратко о Winter Arc — сезон дисциплины |
| `/mini_aps` | Ссылка на мини-приложение «Дневные достижения» |
| `/generate` | Генерация дневного отчёта по целям |
| `/info`     | О проекте и использовании бота |
| `/channel`  | Ссылка на канал новостей (@Motivation_bot_channel) |
| `/support`  | Поддержка проекта (фото с QR, ссылка на оплату) |
| `/a`        | Служебная команда: ручной запуск вечерних напоминаний |

### Inline-кнопки и действия (callback)

- **generation** — сгенерировать отчёт за день (из меню «Генератор отчёта»).
- **show_goals** — показать меню целей (в процессе / выполненные).
- **in_progress_goals** — список целей в процессе с выбором для отметки «Выполнить».
- **toggle_goal_&lt;id&gt;** — отметить/снять отметку цели в списке.
- **Done_goals** — подтвердить выполнение выбранных целей и обновить статус.
- **Done_goals_generation** — в контексте напоминания: отметить выбранные цели выполненными и сгенерировать отчёт.
- **done_goals** — только показать выполненные сегодня цели (без отметки).
- **close_message** — удалить сообщение (закрыть меню).

### Меню бота

В чате задаётся кнопка меню типа `web_app` с URL мини-приложения:  
`https://motivation-oz64.vercel.app/?startapp=story`  
(в коде используется константа `WEB_APP_URL`).

---

## Бот поддержки (bot_) — команды

Используется как FAQ-бот. Команды:

| Команда           | Тема |
|-------------------|------|
| `/start`          | Список всех FAQ-команд |
| `/why`            | Зачем нужен бот «Дневные достижения» |
| `/newGoals`       | Как взять цели (видео) |
| `/accomplishment` | Как выполнить или отменить выполнение цели |
| `/deleteGoals`    | Как удалить цель |
| `/personalGoals`  | Как добавить личную цель |
| `/yesterday`      | Что делать, если забыл отметить вчера |
| `/report`         | Откуда взять дневной/недельный/месячный отчёт (видео) |
| `/achievements`   | Как получить ачивку (видео) |
| `/history`        | Как поделиться ачивкой в историях (видео) |
| `/continuation`   | Планы по развитию проекта |
| `/slowdowns`      | Что делать при медленной работе бота/приложения |
| `/support`        | Поддержка проекта (фото + ссылка) |

Действие **message_close** — удаление сообщения (аналог «Закрыть»).

---

## Расписание (node-cron)

Все задания в часовом поясе **Europe/Moscow**:

| Расписание   | Действие |
|-------------|----------|
| `0 7 * * *` | Утренние напоминания — `sendDailyReminders('morning')` |
| `0 21 * * *`| Вечерние напоминания — `sendDailyReminders('evening')` |
| `0 7 * * 0` | Каждое воскресенье в 7:00 — недельный отчёт `sendWeeklyReport()` |

Напоминания отправляются всем пользователям, полученным через API (`getAllUserIds()`). В сообщении — цели в процессе, возможность отметить выполнение и сгенерировать отчёт. Для серий дней выполнения используются стикеры (уровни «огоньков»).

Недельный отчёт: текст отчёта через `generateSavingGoalsReport` и PNG-график (SVG генерируется в `generateWeeklySVG`, конвертируется через `sharp`).

---

## Модуль Api/Api.js

Базовый URL: `https://motivation-oz64.vercel.app/api`.

### Пользователи

- **addProfile(ctx)** — создать/обновить профиль по данным из `ctx.from`, вернуть объект пользователя (id, telegramId, usersTag и т.д.).
- **getUserData(telegramId)** — данные пользователя по Telegram ID.
- **getAllUserIds()** — список всех пользователей (массив объектов с полями в т.ч. `id`, `telegramId`) для рассылок.

### Цели

- **getAllGoals(customUserId)** — все цели пользователя.
- **initializeUserGoals(customUserId)** — инициализация целей (если у пользователя ещё мало целей): отправка стандартного набора целей (спорт, дисциплина, саморазвитие, духовность и т.д.) на backend.
- **checkGoalCompletion(customUserId)** — проверка срока целей и обновление статусов (например, истёк период).
- **getAllStatus(customUserId, goalId, newStatus, selectedOption)** — обновление статуса цели.
- **updateSavingGoalStatus(userId, date, goalId, newStatus)** — обновление статуса цели в «дневнике» сохранённых целей за дату.

### Сохранённые цели (saving goals) и отчёты

- **getUserSavingGoals(userId)** — массив сохранённых целей по дням (для календаря, серий, отчётов).
- **getUserSavingGoalsWithAutoPeriod(userId)** — то же с автоматическим периодом.
- **clearAllSavingGoals(userId)** — полная очистка сохранённых целей пользователя.
- **generateSavingGoalsReport(userId, period, goalsArray)** — генерация отчёта за период (например, 7 дней); возвращает текст и данные для графика.
- **getGeneraleText(userTag, telegramId, goalsDone, goalsInProgress)** — текст дневного отчёта (запрос на backend `generate-report`).

### Очки и даты

- **addPoints(customUserId, points)** — начислить очки пользователю.
- **addCompletedDate(customUserId, date)** — добавить дату в календарь выполнений.
- **deleteCompletedDate(customUserId, date)** — удалить дату из календаря.

---

## Вспомогательные функции в bot.js

- **svgToPngBuffer(svgString)** — конвертация SVG в PNG (Buffer) через `sharp` (для отправки графиков в Telegram).
- **generateWeeklySVG({ dates, percents })** — генерация SVG графика недельного прогресса (линия + среднее, подписи дат и процентов).
- **sendWeeklyReport()** — рассылка недельного отчёта всем пользователям: текст + PNG-график.
- **sendDailyReminders(timeOfDay)** — рассылка утренних или вечерних напоминаний с целями в процессе и кнопками «Выполнить» / «Сгенерировать отчёт».
- **buildInProgressKeyboard(inProgress, selectedSet, messageType, goals, userId)** — сборка клавиатуры для списка целей в процессе (toggle + «Выполнить» или «Сгенерировать отчёт» для напоминаний).

---

## Шрифты и графика

Для корректной подписи в SVG (недельный график) задаются переменные окружения:

- `FONTCONFIG_PATH` — каталог `fonts` в корне проекта.
- `FONTCONFIG_FILE` — путь к `fonts/fonts.conf`.

Используется при рендере текста в SVG и последующей конвертации в PNG через `sharp`.

---

## Запуск

```bash
npm install
# Заполнить .env: BOT_TOKEN, при необходимости BOT_TOKEN_
npm start
```

`npm start` выполняет `node bot.js`. Сначала запускается основной бот (`bot.launch()`), затем после `getMe()` регистрируются cron-задачи. Второй бот (`bot_`) запускается отдельно (`bot_.launch()`) и обрабатывает SIGINT/SIGTERM своими обработчиками.

---

## Внешние ресурсы

- **Backend и мини-приложение:** https://motivation-oz64.vercel.app/
- **Канал:** @Motivation_bot_channel  
- **Поддержка/вопросы:** @keep_alive_Assistant_bot  
- Ссылка на поддержку проекта (Tinkoff) задаётся в кнопке команды `/support`.

---

## Краткое резюме для разработчика

- Вся логика ботов и расписания — в **bot.js**.
- Вся работа с пользователями и целями — через **Api/Api.js** к Vercel API.
- Два токена: основной бот и FAQ-бот; оба в `.env`.
- Отчёты и напоминания завязаны на `getAllUserIds()` и данные из API (цели, saving goals, отчёты).
- Графики: SVG в коде → `sharp` → PNG → `sendPhoto`.

Если нужно расширить команды или отчёты, править в первую очередь `bot.js` и при необходимости — эндпоинты и формат данных в `Api/Api.js` и на backend.
